---
title: "Data challenge - Predict the Crude Oil production trend"

output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

```{r, warning=FALSE}
library(ggplot2)
library(dplyr)
library(caret)
library(glmnet)
library(tidyverse)
library(MASS)
library(xgboost)
library(leaps)
```


# Introduction

Dans cette analyse, nous pr√©sentons une analyse des donn√©es du data challenge propos√©e par la Soci√©t√© G√©n√©rale : Pr√©dire la tendance de la production de p√©trole brut. Notre objectif est d'√©tudier finement ces donn√©es avec tous les outils statistiques dont nous disposons afin de proposer le meilleur mod√®le de pr√©diction pour la production de p√©trole brut.
Cette analyse est effectu√©e en parall√®le avec une seconde √©tude r√©alis√©e en Python.


# Pr√©sentation des donn√©es 

Les fichiers Train et Test contiennent les doon√©es suivantes:
- ID: ID de la ligne qui contient 12 mois de donn√©es d'un pays donn√© et d'autres informations d√©taill√©es ci-dessus.
- month (mois): Indice de mois. Il n'y a aucune indication concernant l'ann√©e de la collecte des donn√©es.
- country (pays): Indice des pays. Comme indiqu√© ci-dessus, les pays ont √©t√© anonymis√©s.
Et les caract√©ristiques qui sont donn√©es pour chaque mois de l'ann√©e pr√©c√©dente:
- closing stocks (stocks de fermeture) (kmt): repr√©sente le niveau de stock primaire √† la fin du mois dans les territoires nationaux; Comprend les stocks d√©tenus par les importateurs, les raffineurs, les organisations boursi√®res et les gouvernements en milliers de tonnes.
- Exports (exportations) (kmt) / Imports (Importations) (kmt): Quantit√© de p√©trole brut ayant travers√© physiquement les fronti√®res internationales, √† l'exclusion du commerce de transit, des bunkers internationaux de la marine et de l'aviation en milliers de tonnes m√©triques.
- refinery intake (consommation de raffinerie) (kmt): quantit√© totale de p√©trole observ√©e pour entrer dans le processus de raffinage en milliers de tonnes.
- WTI: West Texas Intermediate Price. Cette valeur correspond au cours de cl√¥ture du dernier jour ouvrable du mois en USD.
- SumConsing stocks (kmt), SumExports (kmt), SumImports (kmt), SumProduction (kmt) et SumRefinery intake (kmt): Sommes des features pr√©c√©dentes sur tous les pays sur la m√™me p√©riode en milliers de tonnes.

Le prefix "diff" signifie que les colonnes repr√©sentent la diff√©rence entre la valeur du mois et celle du mois pr√©c√©dent. Le pr√©fixe de la colonne fait r√©f√©rence au mois d'enregistrement. Par exemple, "12_diffExports (kmt)" est la valeur la plus proche de la tendance que nous essayons de pr√©dire et "1_diffExports (kmt)" est la valeur la plus √©loign√©e de la tendance que nous essayons de pr√©dire.

## Read Data

```{r}
train <- read.csv("Train.csv",header=TRUE, sep=';')
test <- read.csv("Test.csv",header=TRUE, sep=';')
Ytrain <-  read.csv("Ytrain.csv",header=TRUE, sep=';')
```

## Analyse Data

```{r}
dim(train)
dim(test)
```

```{r}
head(train[,1:20], n=2)
```

```{r}
glimpse(train)
```

On transforme les variables month et country en variables cat√©gorielles.

```{r, warning=FALSE}
attach(train)
train$month <- factor(train$month)
train$country <- factor(train$country)
```


```{r}
nlevels(train$month)
nlevels(train$country)
```


Il y a 76 pays. Etant donnÈ le nombre de ligne du tableau, chaque pays est reprÈsentÈ par un grand nombre de lignes.


```{r}
unique(Ytrain[,2])
```

On retire ID et on concatËne train avec le label uniquement composÈ de 0 et 1.

```{r}
data <- cbind(train[,-1], Ytrain[,2])
```


On change le nom de la colonne du label.

```{r}
names(data)[123] <- "label"
```

# Graphiques en tout genre 


```{r}
ggplot(Ytrain, aes(x = 1:nrow(Ytrain), y = Target)) + geom_point() + geom_smooth(method = "loess")
```

```{r}
ggplot(data, aes(data$X1_diffWTI, fill = factor(label))) + 
  geom_histogram(bins=30)+
  xlab("data$X1_diffWTI") +
  scale_fill_discrete(name = "label") 
```

```{r}
ggplot(data, aes(month, fill = factor(label))) + 
  geom_bar(stat = "count", position = 'dodge')+
  xlab("Month") +
  ylab("Count") +
  scale_fill_discrete(name = "label") 

ggplot(data, aes(label, fill = factor(month))) + 
  geom_bar(stat = "count", position = 'dodge')+
  xlab("Month") +
  ylab("Count") +
  scale_fill_discrete(name = "month") 




```


```{r}
ggplot(data, aes(x = label , y = X1_diffWTI, fill=label)) + geom_boxplot() 

ggplot(data, aes(x = label , y = X12_diffSumRefinery.intake.kmt., fill=label)) + geom_boxplot()

ggplot(data, aes(x = label , y = X4_diffSumImports.kmt., fill=label)) + geom_boxplot()

ggplot(data, aes(x = label , y = X9_diffSumExports.kmt., fill=label)) + geom_boxplot() +  scale_fill_brewer(palette="Pastel1")


```






```{r}
ggplot(data, aes(country, fill = factor(label))) + 
  geom_bar(stat = "count", position = 'dodge')+
  xlab("country") +
  ylab("Count") +
  scale_fill_discrete(name = "label") 


D <- data.frame(x=1:length(country[1:200]), y= country[1:200], z = data$label[1:200] )

ggplot(D, aes(y, fill = factor(z))) + 
  geom_bar(stat = "count", position = 'dodge')+
  xlab("country") +
  ylab("Count") +
  scale_fill_discrete(name = "label") 
```
https://www.kaggle.com/vincentlugat/titanic-data-analysis-

```{r}
library(ggplot2)
D <- data.frame(x=1:(length(data$X1_diffImports.kmt[250:400])), y= data$X1_diffImports.kmt[250:400])
ggplot(D) + aes(x=x, y=y) + geom_line(aes(x, y), color="blue")+
  xlab(" ") +   ylab("") 
```

```{r}
length(data$X1_diffImports.kmt[100:400])


library(zoo)
s <- na.spline(data$X1_diffImports.kmt.)

D <- data.frame(x=1:(length(data$X1_diffImports.kmt[250:400])), y= data$X1_diffImports.kmt[250:400], z= s[250:400])
ggplot(D) + aes(x=x, y=y, z=z) + geom_line(aes(x,z), color="red") + geom_line(aes(x, y), color="blue")+
  xlab("country") +   ylab("") 
```




# Analyse des donn√©es manquantes 

```{r}
anyNA(data)
anyNA(test)
```


On a un faible pourcentage de donn√©es manquantes.

```{r} 
sapply(data, function(df) {
  sum(is.na(df) == TRUE) / length(df);
})

```


Premi√®re id√©e : 
On d√©cide de supprimer toutes les lignes avec des NA (perte de 294 lignes) pour commencer.


Deuxi√®me id√©e : interpolation


Troisieeme idee ; linear 


```{r}
#spline interpolation
library(zoo)
data$X1_diffClosing.stocks.kmt. <- na.spline(data$X1_diffClosing.stocks.kmt.)
data$X1_diffImports.kmt. <- na.spline(data$X1_diffImports.kmt.)
data$X2_diffClosing.stocks.kmt. <-na.spline(data$X2_diffClosing.stocks.kmt.)
data$X2_diffImports.kmt. <- na.spline(data$X2_diffImports.kmt.)
data$X3_diffClosing.stocks.kmt. <-na.spline(data$X3_diffClosing.stocks.kmt.)
data$X3_diffImports.kmt. <- na.spline(data$X3_diffImports.kmt.)
data$X4_diffClosing.stocks.kmt. <-na.spline(data$X4_diffClosing.stocks.kmt.)
data$X4_diffImports.kmt. <- na.spline(data$X4_diffImports.kmt.)
data$X5_diffClosing.stocks.kmt. <-na.spline(data$X5_diffClosing.stocks.kmt.)
data$X5_diffImports.kmt. <- na.spline(data$X5_diffImports.kmt.)
data$X6_diffClosing.stocks.kmt. <-na.spline(data$X6_diffClosing.stocks.kmt.)
data$X6_diffImports.kmt. <- na.spline(data$X6_diffImports.kmt.)
data$X7_diffClosing.stocks.kmt. <-na.spline(data$X7_diffClosing.stocks.kmt.)
data$X7_diffImports.kmt. <- na.spline(data$X7_diffImports.kmt.)
data$X8_diffClosing.stocks.kmt. <-na.spline(data$X8_diffClosing.stocks.kmt.)
data$X8_diffImports.kmt. <- na.spline(data$X8_diffImports.kmt.)


data$X9_diffImports.kmt. <- na.spline(data$X9_diffImports.kmt.)
data$X9_diffClosing.stocks.kmt. <-na.spline(data$X9_diffClosing.stocks.kmt.)
data$X10_diffImports.kmt. <- na.spline(data$X10_diffImports.kmt.)
data$X10_diffClosing.stocks.kmt. <-na.spline(data$X10_diffClosing.stocks.kmt.)

data$X11_diffClosing.stocks.kmt. <-na.spline(data$X11_diffClosing.stocks.kmt.)
data$X11_diffImports.kmt. <- na.spline(data$X11_diffImports.kmt.)
data$X12_diffClosing.stocks.kmt. <-na.spline(data$X12_diffClosing.stocks.kmt.)
data$X12_diffImports.kmt. <- na.spline(data$X12_diffImports.kmt.)
```


# Correlation


http://www.sthda.com/english/wiki/correlation-matrix-a-quick-start-guide-to-analyze-format-and-visualize-a-correlation-matrix-using-r-software

```{r}
# data$month <- as.numeric(data$month)
# data$country <- as.numeric(data$country)
# mcorr_data <- cor(data[1:10])
# library(corrplot)
#corrplot(mcorr_data,method="circle")
```

```{r}
library(Hmisc)
res <- rcorr(as.matrix(data), type = c("pearson")) #on peut changer pearson
correlation <- abs(round(res$r,2))
p <- res$P
```



```{r}
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

```{r}
result <- flattenCorrMatrix(res$r, res$P)
result2 <- result[abs(result$cor) > 0.6,]
```


# S√©lection de variables 



Rester √† retirer les corr√©lations !

```{r}
 data2 <- data[, -c(which(colnames(data) == "month"), which(colnames(data) == "X1_diffClosing.stocks.kmt."),  which(colnames(data) == "X2_diffClosing.stocks.kmt."),which(colnames(data) == "X3_diffClosing.stocks.kmt."),which(colnames(data) == "X4_diffClosing.stocks.kmt."),which(colnames(data) == "X5_diffClosing.stocks.kmt."),which(colnames(data) == "X6_diffClosing.stocks.kmt."),which(colnames(data) == "X7_diffClosing.stocks.kmt."), which(colnames(data) == "X8_diffClosing.stocks.kmt."), which(colnames(data) == "X9_diffClosing.stocks.kmt."),which(colnames(data) == "X10_diffClosing.stocks.kmt."),which(colnames(data) == "X11_diffClosing.stocks.kmt."),which(colnames(data) == "X12_diffClosing.stocks.kmt."),which(colnames(data) == "X1_diffSumExports.kmt."),which(colnames(data) == "X2_diffSumExports.kmt."),which(colnames(data) == "X3_diffSumExports.kmt."), which(colnames(data) == "X4_diffSumExports.kmt."), which(colnames(data) == "X5_diffSumExports.kmt."),which(colnames(data) == "X6_diffSumExports.kmt."),which(colnames(data) == "X7_diffSumExports.kmt."),which(colnames(data) == "X8_diffSumExports.kmt."),which(colnames(data) == "X9_diffSumExports.kmt."),which(colnames(data) == "X10_diffSumExports.kmt."),which(colnames(data) == "X11_diffSumExports.kmt."),which(colnames(data) == "X12_diffSumExports.kmt."),which(colnames(data) == "X1_diffSumImports.kmt."),which(colnames(data) == "X2_diffSumImports.kmt."),which(colnames(data) == "X3_diffSumImports.kmt."), which(colnames(data) == "X4_diffSumImports.kmt."), which(colnames(data) == "X5_diffSumImports.kmt."),which(colnames(data) == "X6_diffSumImports.kmt."),which(colnames(data) == "X7_diffSumImports.kmt."),which(colnames(data) == "X8_diffSumImports.kmt."),which(colnames(data) == "X9_diffSumImports.kmt."),which(colnames(data) == "X10_diffSumImports.kmt."),which(colnames(data) == "X11_diffSumImports.kmt."),which(colnames(data) == "X12_diffSumImports.kmt."),which(colnames(data) == "X1_diffWTI"),which(colnames(data) == "X2_diffWTI"),which(colnames(data) == "X3_diffWTI"),which(colnames(data) == "X4_diffWTI"),which(colnames(data) == "X5_diffWTI"),which(colnames(data) == "X6_diffWTI"),which(colnames(data) == "X7_diffWTI"),which(colnames(data) == "X8_diffWTI"),which(colnames(data) == "X9_diffWTI"),which(colnames(data) == "X10_diffWTI"),which(colnames(data) == "X11_diffWTI"),which(colnames(data) == "X12_diffWTI"),which(colnames(data) == "X1_diffSumClosing.stocks.kmt."),which(colnames(data) == "X2_diffSumClosing.stocks.kmt."),which(colnames(data) == "X3_diffSumClosing.stocks.kmt."),which(colnames(data) == "X4_diffSumClosing.stocks.kmt."),which(colnames(data) == "X5_diffSumClosing.stocks.kmt."),which(colnames(data) == "X6_diffSumClosing.stocks.kmt."),which(colnames(data) == "X7_diffSumClosing.stocks.kmt."),which(colnames(data) == "X8_diffSumClosing.stocks.kmt."),which(colnames(data) == "X9_diffSumClosing.stocks.kmt."),which(colnames(data) == "X10_diffSumClosing.stocks.kmt."),which(colnames(data) == "X11_diffSumClosing.stocks.kmt."),which(colnames(data) == "X12_diffSumClosing.stocks.kmt."))] 
```
 
 
```{r}
 library(leaps)
 choix <- regsubsets(label~.,data=data2,  really.big=T)
 plot(choix,scale="bic")
 ```





Premier fit avec toutes les donn√©es 
```{r}
fit = lm(label ~ .  , data = data)
summary(fit)
```

Supprimer les variables avec la plus grande p values pas forc√©ment une bonne id√©e.


```{r}
library(leaps)
 
choix <- regsubsets(label~.,data=data,nbest=1,nvmax=11, really.big=T)
plot(choix,scale="bic")
```



```{r}
Mat_test <-  model.matrix(~ month + country + X1_diffClosing.stocks.kmt. + X1_diffExports.kmt. + 
     X1_diffImports.kmt. + X1_diffRefinery.intake.kmt. + X1_diffWTI + 
     X1_diffSumClosing.stocks.kmt. + X1_diffSumExports.kmt. + 
     X1_diffSumImports.kmt. + X1_diffSumProduction.kmt. + X1_diffSumRefinery.intake.kmt. + 
     X2_diffClosing.stocks.kmt. + X2_diffExports.kmt. + X2_diffImports.kmt. + 
     X2_diffRefinery.intake.kmt. + X2_diffWTI + X2_diffSumClosing.stocks.kmt. + 
     X2_diffSumExports.kmt. + X2_diffSumImports.kmt. + X2_diffSumProduction.kmt. + 
     X2_diffSumRefinery.intake.kmt. + X3_diffClosing.stocks.kmt. + 
     X3_diffExports.kmt. + X3_diffImports.kmt. + X3_diffRefinery.intake.kmt. + 
     X3_diffWTI + X3_diffSumClosing.stocks.kmt. + X3_diffSumExports.kmt. + 
     X3_diffSumImports.kmt. + X3_diffSumProduction.kmt. + X3_diffSumRefinery.intake.kmt. + 
     X4_diffClosing.stocks.kmt. + X4_diffExports.kmt. + X4_diffImports.kmt. + 
     X4_diffRefinery.intake.kmt. + X4_diffWTI + X4_diffSumClosing.stocks.kmt. + 
     X4_diffSumExports.kmt. + X4_diffSumImports.kmt. + X4_diffSumProduction.kmt. + 
     X4_diffSumRefinery.intake.kmt. + X5_diffClosing.stocks.kmt. + 
     X5_diffExports.kmt. + X5_diffImports.kmt. + X5_diffRefinery.intake.kmt. + 
     X5_diffWTI + X5_diffSumClosing.stocks.kmt. + X5_diffSumExports.kmt. + 
     X5_diffSumImports.kmt. + X5_diffSumProduction.kmt. + X5_diffSumRefinery.intake.kmt. + 
     X6_diffClosing.stocks.kmt. + X6_diffExports.kmt. + X6_diffImports.kmt. + 
     X6_diffRefinery.intake.kmt. + X6_diffWTI + X6_diffSumClosing.stocks.kmt. + 
     X6_diffSumExports.kmt. + X6_diffSumImports.kmt. + X6_diffSumProduction.kmt. + 
     X6_diffSumRefinery.intake.kmt. + X7_diffClosing.stocks.kmt. + 
     X7_diffExports.kmt. + X7_diffImports.kmt. + X7_diffRefinery.intake.kmt. + 
     X7_diffWTI + X7_diffSumClosing.stocks.kmt. + X7_diffSumExports.kmt. + 
     X7_diffSumImports.kmt. + X7_diffSumProduction.kmt. + X7_diffSumRefinery.intake.kmt. + 
     X8_diffClosing.stocks.kmt. + X8_diffExports.kmt. + X8_diffImports.kmt. + 
     X8_diffRefinery.intake.kmt. + X8_diffWTI + X8_diffSumClosing.stocks.kmt. + 
     X8_diffSumExports.kmt. + X8_diffSumImports.kmt. + X8_diffSumProduction.kmt. + 
     X8_diffSumRefinery.intake.kmt. + X9_diffClosing.stocks.kmt. + 
     X9_diffExports.kmt. + X9_diffImports.kmt. + X9_diffRefinery.intake.kmt. + 
     X9_diffWTI + X9_diffSumClosing.stocks.kmt. + X9_diffSumExports.kmt. + 
     X9_diffSumImports.kmt. + X9_diffSumProduction.kmt. + X9_diffSumRefinery.intake.kmt. + X10_diffClosing.stocks.kmt. + X10_diffExports.kmt. + X10_diffImports.kmt. + X10_diffRefinery.intake.kmt. + X10_diffWTI + X10_diffSumClosing.stocks.kmt. + X10_diffSumExports.kmt. + X10_diffSumImports.kmt. + X10_diffSumProduction.kmt. + X10_diffSumRefinery.intake.kmt. + X11_diffClosing.stocks.kmt. + X11_diffExports.kmt. + X11_diffImports.kmt. + X11_diffRefinery.intake.kmt. + X11_diffWTI + X11_diffSumClosing.stocks.kmt. + X11_diffSumExports.kmt. + X11_diffSumImports.kmt. + X11_diffSumProduction.kmt. + X11_diffSumRefinery.intake.kmt. + 
     X12_diffClosing.stocks.kmt. + X12_diffExports.kmt. + X12_diffImports.kmt. + 
     X12_diffRefinery.intake.kmt. + X12_diffWTI + X12_diffSumClosing.stocks.kmt. + 
     X12_diffSumExports.kmt. + X12_diffSumImports.kmt. + X12_diffSumProduction.kmt. +
     X12_diffSumRefinery.intake.kmt.)
```
# https://cran.r-project.org/web/packages/olsrr/vignettes/variable_selection.html
 
```{r}
 library(olsrr)
 ols_all_subset(fit)
```





```{r}
set.seed(234)
n <- nrow(data)
ord <- sample(1:n)
train_valid <- slice(data, ord[1:floor(0.7*n)])
test_valid <- slice( data, ord[(1+floor(0.7*n)):n])
```


```{r}
fit = lm(label ~ .  , data =  train_valid )
```

```{r}
X <- as.matrix(train_valid[,-123])
Y <- train_valid$label
```

# ridge 

```{r}
fit_ridge <- glmnet(X, Y, alpha = 0, family = "binomial")
plot(fit_ridge)
predictions <- predict(fit_ridge, as(X, "dgCMatrix"))
mse <- mean((Y - predictions)^2)
print(mse)

fit_ridge_cv <- cv.glmnet(as(X, "dgCMatrix"), Y, alpha = 0, family = "binomial")
plot(fit_ridge_cv)
```

On choisit le lambda le plus petit inclut dans l'intervalle de confiance.


```{r}
mean((predict(fit,train_valid)-Y)^2)
```

# lasso

```{r}
fit_lasso <- glmnet(as(X, "dgCMatrix"), Y, alpha = 1, family = "binomial")
plot(fit_lasso)

predictions <- predict(fit_lasso, as(X, "dgCMatrix"))
mse1 <- mean((Y - predictions)^2)
print(mse1)

fit_lasso_cv <- cv.glmnet(as(X, "dgCMatrix"), Y, alpha = 1, family = "binomial")
plot(fit_lasso_cv)
```

```{r}
dim(X)
```

```{r}
ggplot(data.frame(X=coef(fit)[2:length(coef(fit))], Y=coef(fit_lasso_cv)[2:length(coef(fit))] +coef(fit_ridge_cv)[2:length(coef(fit))])) +  geom_point(aes(y = X, x = 1:122, color='Standard')) + geom_point(aes(y = Y, x = 1:122, color='Lasso')) + geom_point(aes(y = Z, x = 1:122, color='Ridge'))+ theme(legend.position = "bottom") + scale_fill_manual() + theme(legend.position="left")  + scale_y_continuous("Valeurs des coefficients estimÈs") + scale_x_continuous("") + ggtitle("RÈgressions standard et pÈnalisÈes")
```






# Xgboost

https://www.kaggle.com/jeremiespagnolo/beginner-s-guide-to-mercari-in-r-0-50677


```{r}
library(xgboost)
```

```{r}
set.seed(123)
n <- nrow(data)
ord <- sample(1:n)
library(caTools)
split <- sample.split(data,SplitRatio=0.7)

trainXG <- subset(data, split==TRUE)
validXG <- subset(data,split==FALSE)
yTrainXG <- trainXG$label
yValidXG <- validXG$label

# testXG <- test
# 
# trainXG <- trainXG[,-123]
# validXG <- validXG[,-123]
```

```{r}
new_tr <- model.matrix(~.+0,data = trainXG[,-123]) 
new_ts <- model.matrix(~.+0,data = validXG[,-123])
```


```{r}
labels <- as.numeric(yTrainXG)-1
ts_label <- as.numeric(yValidXG)-1
```

```{r}
dtrain <- xgb.DMatrix(data = new_tr,label = labels) 
dtest <- xgb.DMatrix(data = new_ts,label=ts_label)
```

```{r}
params <- list(booster = "gbtree", objective = "binary:logistic", eta=0.3, gamma=0, max_depth=6, min_child_weight=1, subsample=1, colsample_bytree=1)
```



```{r}
xgbcv <- xgb.cv( params = params, data = dtrain, nrounds = 100, nfold = 5, showsd = T, stratified = T, print.every.n = 10, early.stop.round = 20, maximize = F)

```

```{r}


rmseEval=function(yTrain,yPred) {
  mseEval=sum((yTrain - yPred)^2)/length(yTrain)
  return(sqrt(mseEval)) }

```

```{r}
xgPrm <- list(boost='gbtree',objective='reg:linear',colsample_bytree=1,
              eta=0.095,max_depth=9,min_child_weight=1,alpha=0.3,
              lambda=0.4,gamma=0.2,subsample=0.8,seed=5,silent=TRUE)
xgbModel <- xgb.train(xgPrm,xgTrain,nrounds=300,watchlist=list(train=xgTrain,test=xgValid))
```


```{r}
ypredXgbTrain <- predict(xgbModel,xgTrain)
rmseEval(yTrainXG,ypredXgbTrain)
ypredXgbValid <- predict(xgbModel,xgValid)
rmseEval(yValidXG,ypredXgbValid)
ypredXgb <- predict(xgbModel,xgTest)
```

```{r}
length(ypredXgb)
```

```{r}
df <- data.frame(x=test$ID, y=ypredXgb, ncol=2)
```

```{r}
write.csv(df, file = "Test6.csv")
```










